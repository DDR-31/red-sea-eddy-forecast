import cdsapi
import os

# --- Pengaturan ---
output_dir = "../data/era5_data"
os.makedirs(output_dir, exist_ok=True) # Membuat folder untuk menyimpan file

start_year_total = 1982
end_year_total = 2023
step = 5 # mengunduh dalam potongan 5 tahun


client = cdsapi.Client()

# --- Loop untuk mengunduh data per potongan ---
print(f"Memulai proses unduhan data ERA5 dari {start_year_total} hingga {end_year_total}...")

for start_year in range(start_year_total, end_year_total + 1, step):
    end_year = min(start_year + step - 1, end_year_total)
    years_chunk = [str(y) for y in range(start_year, end_year + 1)]
    
    output_filename = os.path.join(
        output_dir, 
        f"era5_daily_redsea_0.125deg_{start_year}-{end_year}.nc"
    )

    if os.path.exists(output_filename):
        print(f"⚠️  File {output_filename} sudah ada, lewati...")
        continue
    
    print(f"\n---> Memproses request untuk tahun: {start_year} - {end_year}")
    print(f"     File output akan disimpan sebagai: {output_filename}")

    # Kamus request untuk potongan saat ini
    dataset = "reanalysis-era5-single-levels"
    request = {
        "product_type": ["reanalysis"],
        "variable": [
            "10m_u_component_of_wind",
            "10m_v_component_of_wind",
            "2m_temperature",
            "mean_sea_level_pressure",
            #"surface_net_solar_radiation"
        ],
        "year": years_chunk, # Menggunakan potongan tahun saat ini
        "month": [
                  "01", "02", "03",
                  "04", "05", "06",
                  "07", "08", "09",
                  "10", "11", "12"
        ],
        "day": [
                "01", "02", "03", "04", "05",
                "06", "07", "08", "09", "10",
                "11", "12", "13", "14", "15",
                "16", "17", "18", "19", "20",
                "21", "22", "23", "24", "25",
                "26", "27", "28", "29", "30",
                "31"
        ],
        "time": ["12:00"],
        "data_format": "netcdf",
        "download_format": "unarchived",
        "area": [28, 34, 14, 45],
        "grid": [0.125, 0.125],
    }

    # Mengirim request ke server
    client.retrieve(dataset, request).download(output_filename)


    print(f" Sukses! Request untuk {start_year}-{end_year} telah selesai.")

print("\n=============================================")
print("Semua proses unduhan telah selesai!")
print(f"Silakan periksa file .nc di dalam folder '{output_dir}'.")
print("=============================================")
